--- 
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/",
  eval = TRUE
)
```

# Track Covid-19 severity measures

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)

## Installation

Install the unstable development version of the package with: 

```{r, eval = FALSE}
remotes::install_github("epiforecasts/covid19.track.severity")
```


## Proof of concept

* Packages

```{r}
# Packages ----------------------------------------------------------------
library(covid19.track.severity)
library(idbrms)
library(brms)
library(dplyr)
library(purrr)
```

* Load data

```{r}
obs <- get_uk_obs_grid(date_from = Sys.Date() - 4 * 7 * 12, 
                       date_to = Sys.Date()) %>% 
  filter(level %in% "DA") 
# set number of parallel cores
options(mc.cores = 4)
```

* Prepare for modelling

```{r}
obs <- obs %>% 
  mutate(data = map(data, prepare, model = "convolution", max_convolution = 20))
```

* Model

```{r} 
fit <- idbrm(data = obs$data[[1]],
             family = negbinomial(link = "identity"),
             formula = id_formula(obs$data[[1]],
                                  scale = ~ (time | location),
                                  cmean =  ~ (1 | location),
                                  lcsd =  ~ (1 | location)),
             priors = id_priors(obs$data[[1]],
                                scale = c(log(0.05), 1),
                                cmean = c(log(5), 0.25),
                                lcsd = c(log(0.5), 0.25)))
```


* Summarise model

```{r}
summary(fit)
```

* Random effects 

```{r}
ranef(fit)
```
